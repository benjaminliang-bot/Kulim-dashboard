
WITH low_jia_ying_merchants AS (
    SELECT merchant_id_nk
    FROM ocd_adw.d_merchant
    WHERE city_id = 13
        AND merchant_id_nk IN ('1-CZLBFBBYC7VKLE', '1-C3LGN4EHCF2HT2', '1-C2C2MBA2NKW3C6', '1-C64FSBJWGXTYME', '1-C66YC7XUTPMTKE', '1-CZEHGFEWAZCZRX', '1-CYUBJE3DA3MBAN', '1-CY5ZUAVTAE6ATE', '1-C34XVBKGVT5UDE', '1-C6DHNAWTVCAYTE', '1-C34WBAL1WFUAT6', '1-C3UZNNXYBALWNN', '1-C7ECGJVCDBXWGA', '1-C24CVJEJSBKBWE', '1-C26KG62URFEJV6', '1-C64FSF5WTBA3NT', '1-CZDJNNA1CE5GRN', '1-CZM2EFAXJKWAGA', '1-C26XJ6WAHB4WCT', '1-C7AWE7CZJVMAA6', '1-C3AXJBNGNJTXMA', '1-C2VEJA5XVK51DA', '1-C3KVRP6VVBXECX', '1-C6KBE4JKE4JJEN', '1-C4DGA62YCPJ2RJ', '1-C6T2V4MZSB23NT', '1-C32TPF3VPBXZLX', '1-C2CDAPTVBBVHEA', '1-CZLVJT6KAJ5CG2', '1-C2DYWA5GAVD2CA', '1-C23JT2JVJPVDVN', '1-CZDJNNA1CBD2HA', '1-C6LBC2XCPFWCRJ', '1-C6BCVEXTJKXECJ', '1-C2AVPADYTEECTA', '1-C23CE6KJAP6DGX', '1-C4DJEPC3AGA3BA', '1-C4EYNTT2WEJ2L6', '1-C2WZJ8L3EXDYAN', '1-C62WTTE2CJKWDE', '1-C32BGEXEE7UJNN', '1-C6UYG653N3KWKE', '1-C3BDV4MHCVAYV6', '1-CZEHGFEWCJ2VJE', '1-CZKUPFKBJ7NGCN', '1-C6VKVLEYBE23VA', '1-C2MUNU5KCEMGT6', '1-C36VGUJBHF2ECE', '1-C2XWLYVENVDJWA', '1-C3DXVP3YTXA3LX', '1-C33HCKE2PBXGME', '1-C25FJN3DRJA1NT', '1-CZJWLAXGGKKKR6', '1-C3DDVNWGBABDTX', '1-C6WKBE5BDGAVV6', '1-CZEHGFEWAXJDKE', '1-C36UCYXHEVD1VE', '1-C3VWSEW3LP32CN', '1-C6JKVXDWJ3WATE', '1-C35UE62FREKVME', '1-C3NHDE4FTU5BGA', '1-C3MZV4ETAUUENN', '1-C6BDLA5EJKXUWE', '1-C6KYEJJ1EU2HA6', '1-C3WAACNHHB4JTA', '1-C4J3TEKYPFLATA', '1-C36XTLMZL7K2WE', '1-C2X3VK42AKCZWE', '1-C2A2J33VNVMJJX', '1-C2KFCJ2WAEEGSE', '1-C4JXRPN3RULKAE', '1-C3VZGP2HE6TKRJ', '1-C26WL6WKPCLFRT', '1-C3NZA2EUCYAHUA', '1-CZLHFBVXJFDKJT', '1-C2XTWGKJC3TUBA', '1-C3EHTUJWTTW1UA', '1-C3NHGAEALXMGCJ', '1-C3XFVTUZSE31AE', '1-C2UAVGKJL3JBTJ', '1-C6AVKB4FBGKXLN', '1-C4NCEZEXLLEJBA', '1-C3UZNYX1L2UALN', '1-C6TWR6CKDA5DRX', '1-CZDDHA6FKAUKN6', '1-C6UUVZMYA76KAJ', '1-C3XZCLJHCTBYTA', '1-CZE3L323ACB3EJ', '1-C3A2RXACC2AYVX', '1-C6VKEZKUT7UTTA', '1-C4LGSGBYSAE1JT', '1-C2J2V4DVAE2JV2', '1-C3DXGBDKLLA1E6', '1-C6NWVVM1J8C1WA', '1-C3KKCAEHVUTESA', '1-C2TZAPKHCEDHJT', '1-C2UZNK41C3JUNN', '1-C6VWMEAJL233N2', '1-C6JFR3TGNP52KA', '1-C66KEKTTE36DVN', '1-C4DYA662V4A1C6', '1-C22YEXWWA4AYGE', '1-CZLHFBVXJN5ECE', '1-C3VENEW3NAV1TT', '1-C2BZTKUUKEJWL2', '1-C2BZTKUUJ2BHC6', '1-C7MBEP3TPAJGJJ', '1-C2JTGJTCA7DTCX', '1-C7LZRAA3NE4WWA', '1-CYLJTJDBJ63BRE', '1-C7DVTTTVRZBKTT', '1-C6VHEX2FJ4BYCE', '1-C222L7MKAJDAJT', '1-C24BEFXVNBJJAJ', '1-CZBCPFUJLB2DE6', '1-C2WWR8NHE62ERJ', '1-C66UTFJ3EBUYEE', '1-C2NFLKJZCYMGRN', '1-C6E2NCLHNEJBEX', '1-CZEFEF5ESE3EHE', '1-C2T3RT4XTBUWA2', '1-CZEHHAEXFEM2R2', '1-C632CF2DUFLASE', '1-CZDWTALTLPJUUA', '1-C3NHJYXZTB5ELX', '1-C3KXJX3HATXCCA', '1-C3WHLN5XLZCWR6', '1-C3UHFFW1L2NCTN', '1-C3DGHE2YJZEKLE', '1-C25VFFX2VXA3NE', '1-C2WDGXL1NBD2N6', '1-C6LGJLMCNANCJJ', '1-C4MZUBDANRABRN', '1-C25GANW2KF5XA2', '1-C33GHAKAFAM1UE', '1-C4CCEF5ZR3CBAA', '1-C2WYLE5ERCD1SA', '1-C36CLLD3NA4DVN', '1-C7DBNUNFPE31LN', '1-C4LUC32ENFV3GT', '1-C4AEUF2YKEW3AX', '1-C3L2N4JUKBWWRT', '1-C3MKA63AENAHSA', '1-C35DJ3BDRU2CVA', '1-C3L3RAEYWF2YTN', '1-C3D3G23WEKAKGJ', '1-C7ACA3E3ALNYR2', '1-C2JTLAJWDE6HEX', '1-C3LCLLJBVFEHGN', '1-C4CXE33CDFBZE2', '1-C2KKE8L1DFN1HA', '1-C6NWCJE3TETECX', '1-C62JNUM3APLFNT', '1-C2VKLFL2VFX1UA', '1-C7KAG7BUJU4YFA', '1-CZK1JRJDR8C2WE', '1-C352C63EMBWGAT', '1-C3NZAE2EVPNVET', '1-C6LVEAEWFEDXJN', '1-C3JCMAJZWGCGSA', '1-C3LFUCKETCNCVX', '1-C25ZMAJUVUNXC6', '1-CZDWTALTEJW2ME', '1-CZDWTALKVAAHSA', '1-C351GY4YSEKJTA', '1-CZDEVYUHT7UKA6', '1-C3EBTUTVA7T3V2', '1-C3K2UAJCAXBUJA', '1-C6CHTREEEU2TJE', '1-C6JGAE4ZJTNTKE', '1-C65DA3NVPFEJL6', '1-C6AZT3ECNPD2G6', '1-C2MEPEECV3AJCX', '1-C4C2LAEAC6EDFA', '1-C2WDEB3JDB5TRJ', '1-C2CDAPTVC3XKG2', '1-C7LANAVGV4LXLA', '1-C35FJY5FNU2UEA', '1-C7EKEPEBSCBVRN', '1-C7K2L4B1JJVWCT', '1-C2U1NU3KARDJDA', '1-CY5FNLDVVXAEVA', '1-C24CTADDCELCDE', '1-C3NJE2L1R6NCPA', '1-C2XJNJ3JEN3TEN', '1-C7BTNFJDCXUBME', '1-C251ELKYEYNKGA', '1-C7JZA8BHWAAYAX', '1-C6LCAE5VRCJ3JT', '1-CYTDEXJUNALJKE', '1-C2JTGJTCGNJFAJ', '1-C2E1LUJEJVEDE6', '1-C3ETLNXGHA2TJA', '1-C7KETE4AMETFA2', '1-C7JWPFJYRFE3LX', '1-C7L2RGDATA5JCE', '1-C2XAUA6JC2JDV6', '1-C353BF3UCJCAGA', '1-C4ETME4FGB3URE', '1-C3LJL7XTNLE2LT', '1-C242FALXL24YRN', '1-C62KMFXZNYMXAJ', '1-C66DSCNHJAXFSA', '1-C3VEETLDVKBFNX', '1-C3A3KE4FGP2YLT', '1-C7LGLAVZVCLELJ', '1-C3ABL72ENATYA2', '1-C3KDJE4CLFJYAE', '1-C3KWUCJCHCEWLA', '1-C7EKEJT2ARMFC6', '1-C3WCLTLKGJX1LJ', '1-C2XCE7VCUFKAGN', '1-C32DC6X2VZJ2VT', '1-C6N3CA3GATBVE6', '1-C33HJKKDLVNFJ6', '1-C7ABE64JLKL2RX', '1-C7MBEP3TG7MAJN', '1-C7LERGKZWE2AA6', '1-C7LFHFMJCTTVME', '1-CZCTGF3JGCJEG6', '1-C2XFTRMDLETHNN', '1-C2VEGT5UEBVGKE', '1-C6LBDFW3TVCXVT', '1-C7MBCVMAN2UAG6', '1-C6NYPEN3NJV1TN', '1-C23ETK6XAJVBKE', '1-C33GGUKCMCCFRX', '1-C3W3TEAVG2MWCT', '1-C3CZSEEAKBEVGN', '1-C7KYVRBALRLTVA', '1-C3NKL64GL2AHLX', '1-C22DRT3HVNBJEX', '1-C63JPFX3R3A1GJ', '1-C2KXN4CCTBUHJX', '1-CZK1JRJDWEDTNE', '1-C2XALEKJGF4XJA', '1-C3KDJE4CLRKCGE', '1-C2WXANKJVLNTHE', '1-C4JEJ23UCF2ZC2', '1-C6BEME2VVXTAKE', '1-C2XAPENTAYL2AJ', '1-C7L3FECUG4JHJA', '1-C3UBRFXAPE6FNJ', '1-C7L3GE2JRUBKTN', '1-C2XGTENJMELYLN', '1-C66KEE4ECT4TSE', '1-C4K3T2WBJUJWTE', '1-C7EKGTVHRKVGA6', '1-C2TJAFW3AKV2EE', '1-C7LCTX2FDETVMA', '1-C4LWLT3JVVBYR6', '1-C4CJWBMUNYM2DE', '1-C3WDV4DZAK53AE', '1-C2WXANL1JE21LN', '1-C2VEE2B3GE4ZL2', '1-C2ADHCCVC2XHGX', '1-C3NXA4DGLJXZCA', '1-C7AGJJTXJPEWNT', '1-C7LCTJ2VA3EAEX', '1-C3WANUK1JLEARN', '1-C23ETK5ATE3JV2', '1-C7LZRAA3MAU3NJ', '1-C7ADSAJHTJUKR6', '1-C4JZJFCALZMJLT', '1-C62JNZBUEBAKR6', '1-C65DVYAERFTAG2', '1-C242GLEWNUCJR2', '1-C3TKN4DVTEMEKE', '1-C6W2HE3DN6BZGJ', '1-C3TKN4DVT6DDJX', '1-C7ADVAKTJFAYDE', '1-C7JTCANBPGMXJA', '1-C7MBBEXYVYNGCN', '1-C3DKA4MFMFU3GJ', '1-C32CEPXVDCEYGA', '1-C3LFWBE3C26JTN', '1-C3VCRTE2FE3CDA', '1-C3UTLKKEG3KCLE', '1-C3XBLALGNLDKTN', '1-C32HKE3TWFEHVA', '1-C26KL3KFPGAFC6', '1-C351KCLWNBCEAX', '1-C3KBLGAEFBTFET', '1-C7A1LJ3ZLGCZCX', '1-C7D1BCDYL3UGHA', '1-C3UBRTJUBFUGSE', '1-C4EDRVNJLA5TEJ', '1-C3BFN6CYPFM2RE', '1-C7LDNBVYE7UACE', '1-C7L1LAXYVBL3TX', '1-C3XJGF2UTJLZR6', '1-C222NU3JTAKGL2', '1-C26WSAXGUCABTN', '1-C35ZLTUJSGAKEX', '1-C3X1VBE2E8DKVJ', '1-C3TBCPWGVAUAL6', '1-C7D1FBJYBE52V2', '1-C24WEBKXVE5CGT', '1-C3DXV6X1RNUAVJ', '1-C3BTVBJXV6VZPE', '1-C3NBE732J6TZAN', '1-C7K3N7CAEZMCTT', '1-C4A3NULCVLKWEA', '1-C2BJCXLHE25JC6', '1-C6V3HGJUTNDDME', '1-C7E1BFMKHFBHRN', '1-C3KBLGAEG2UZTE', '1-C26KJJDFATDEC2', '1-CZDKECDXL7V1A2', '1-C6TWNJAYAPUDEA', '1-C6KVLEKHMAXGGT', '1-C4MVC8C3JUBELA', '1-C6UFAYDJAX6AG2', '1-C6VXJNB2J2CKGX', '1-C4NDVXDWLLK3ME', '1-CZDWTALTTU3GTN', '1-C3KJJ4MKGUXBSA', '1-C2UFL23KGPUVAJ', '1-C3E1GVKZME5WLA', '1-CZDWTALUC3C1LX', '1-C3E3TY3EV6ETC6', '1-C632E2UTSAWXLX', '1-C3NBCPAFE3AENX', '1-C36HBCKGRCNJRT')
),
monthly_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        COUNT(DISTINCT f.merchant_id) as unique_merchants,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.order_id END) as orders,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.passenger_id END) as unique_eaters,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
        AND f.merchant_id IN (SELECT merchant_id_nk FROM low_jia_ying_merchants)
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
),
total_penang_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as total_penang_gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
)
SELECT 
    mg.month_id,
    'Low Jia Ying' as mgs_name,
    mg.unique_merchants,
    mg.orders,
    mg.unique_eaters,
    mg.gmv,
    tp.total_penang_gmv,
    ROUND(mg.gmv * 100.0 / NULLIF(tp.total_penang_gmv, 0), 2) as gmv_pct_of_penang,
    ROUND(mg.gmv / NULLIF(mg.unique_merchants, 0), 2) as avg_gmv_per_merchant,
    ROUND(mg.gmv / NULLIF(mg.orders, 0), 2) as avg_gmv_per_order,
    ROUND(mg.gmv / NULLIF(mg.unique_eaters, 0), 2) as avg_gmv_per_eater
FROM monthly_gmv mg
INNER JOIN total_penang_gmv tp ON mg.month_id = tp.month_id
ORDER BY mg.month_id;
