
WITH hon_yi_ni_merchants AS (
    SELECT merchant_id_nk
    FROM ocd_adw.d_merchant
    WHERE city_id = 13
        AND merchant_id_nk IN ('1-C653LBNKR73ZEA', '1-C3XUVX4CNB2UVX', '1-C6MXVBVBSCKTTN', '1-C22VJYWZFCLAVA', '1-CZKKUETTN34BAX', '1-C6XENCM3GGDGLN', '1-C2NCCP5AWBUTJE', '1-C6AWDAUBNNUBG2', '1-C6L1NVJJKFTDVA', '1-C7AAHBNVEF2CDA', '1-CZNUAUVYN6XHCJ', '1-C7BDTABYCLDVKE', '1-C3VHR4JTCP2WJT', '1-C3DGGUJUJKMYTN', '1-C6CTLKLZTTBJVE', '1-CY61NKMVBCEAJX', '1-C2XCAEKHVXCHBA', '1-C4KKJUMVE36VTA', '1-C6DWTTWTC65VPE', '1-C2VUG23JTKBKDA', '1-C7D1GTCUAEACTJ', '1-C4NCC232L332CN', '1-CY61NKMVG7JZAA', '1-C3DJTBLWWFDUTN', '1-C63HPCJXNFWFDA', '1-C3XAT7WHCKMYVE', '1-C2U2JRKJANDJGA', '1-C6AGEN4BLZBTJJ', '1-CZDDCUNTCYVXDA', '1-C23ZRBDCNADHJN', '1-C23EN2K2NPXHT2', '1-C6CZGN6XCFNTLT', '1-C22VA3WBNJKKSA', '1-C3TGEBBFEEXJRA', '1-C6VXCTLZEX4GET', '1-C6NBR4JTEKNBRA', '1-C65XLFBGJXNDR6', '1-C4L1T2NGMEEAME', '1-C4DDAE32VJ5JTA', '1-C3UVVKDHLGL1TA', '1-C7MWV4A3GJ3CG2', '1-C3U3WADTGECARN', '1-C3VZJNXTENWALJ', '1-C4AANE5AT2LYJT', '1-C22YCFCZG62ZGX', '1-C2VGHCEZT73BR2', '1-C6VXG4NTELDEAA', '1-C3XVPFXGG2EFGX', '1-C6A1PE4WFAVEAA', '1-C25ZN3EZGJVHKA', '1-CZL3VATJN24ZWA', '1-C2UGC24YUANXJX', '1-C33XUCKXAELECA', '1-C3LFWBE2WBMJDA', '1-C4DBWAJWJALJNT', '1-C33KRTKHLNK1TT', '1-C4MAJ3TTCZJCCJ', '1-CZLAGTUAJNCHEJ', '1-C6CKLYACGUXEDA', '1-C2MVJ7CGJNXYRT', '1-C26YNKDYDAU3L2', '1-C26TJLJ3VCBFJA', '1-C2T2G7LYRFUABE', '1-C3EXAE3HJ2TWLE', '1-C4MZCXJGKEUZV6', '1-C2LGL7J1PE51NA', '1-C2LHRBACATCAKE', '1-C3KCN4EUAEBYLJ', '1-C3LHNFXWELBCLA', '1-C4EGFFCDEELGUE', '1-C4JDLK4ZPFTYJA', '1-C65KGLMXUE6GA2', '1-C2J3C3ATMGCWEX', '1-C3WJLFW3JN4KN2', '1-C7JDVZMAFF51C2', '1-C24ULE2TGUTDGN', '1-C4CCCCMYSBBGN6', '1-C6WURUM2BAAHRN', '1-CZECG2VZLN5VKE', '1-C3KEELJJVPEUHA', '1-C2VCT8KKL7VVN2', '1-C33HCVLUMEN1AA', '1-C3CJDBE1L66YRN', '1-CYLJTJC1VED1G6', '1-C3LHLYXEGXKWJJ', '1-C6LHEJXBCJDUGE', '1-C4CUN2CXRCBEAX', '1-C2T2GRLZBB2UAA', '1-CZJWLAXGGCBYG6', '1-C4CTVTECWA4EN6', '1-C3WAR7XYCN6HA2', '1-C3BWJE3UJJ3FPA', '1-C2XFN2A3N36AAE', '1-C6BJWF2XC2N2NX', '1-C2BAJFNVVU5VAT', '1-C2DJTANEAAMELE', '1-C2BXELMYA6JZG2', '1-C25ZNTKEDB5DWA', '1-CZL3VATJPGCYAJ', '1-CY5EN3NYTXEAVJ', '1-C2JVUA2HJYTVE6', '1-C6VHL6JYJYBHL2', '1-C2KCNFA1EAABEA', '1-C6K3JECGLBLVAE', '1-C2UGTJ3JGYJHEA', '1-C2U2J3AYLRLACT', '1-C6TBME5VL73DE6', '1-C2DHGNMJEE41ET', '1-C3BWLCEJGX3UAN', '1-C2LAR6J3GJXEGE', '1-C4BKWEVEA6D3L2', '1-C6NHTTUFRYTTVA', '1-C2DWGXJCAPDVSA', '1-C2EVCJTJAN23GJ', '1-C6KVME5JT6BFVA', '1-C4JTJ2XFTUAGVX', '1-C7C3CTBBGTKZG2', '1-CYWBWBDHGBTWN2', '1-C2VELXN2DACBJA', '1-CY4BJ4CCFFABV2', '1-C7ETA2VVVJLGFA', '1-C6TAPFA1G7CVDA', '1-C3DJC4N3MFLAAJ', '1-C3LFTNAGTTLCCT', '1-C3LXMCJAJ2NBCN', '1-C2VCV23JAPMBLJ', '1-C3JKJUEBDGN2GT', '1-CZDEUCDAR25GRE', '1-C2WZHA5FLKK1TE', '1-C6XCVTNGRFNYNX', '1-C7CCLXXEKBATHA', '1-C3XFFA3GMANAG2', '1-C32XJX3WMFLHTA', '1-C23KN2DEVT6EJT', '1-C2KCJPJCRKAJAJ', '1-C35DG6ADR22BRE', '1-C62KLECVRRNHAE', '1-C2LGL7K2T24KG2', '1-C3MTT2EYNREBRE', '1-C6VETTKDV3KCEN', '1-C24UNCDDWELUEE', '1-C24VGBETBANET2', '1-C4L3TYBVHBBGNX', '1-C32UL6WHT3KKE2', '1-C2KDKFNEEK5FLE', '1-C6WUPBVWKA5XG2', '1-C4A3NJ5AEUJTGN', '1-C2JUGZDKTFUDTX', '1-C4EFLVKZAJ5EG2', '1-C6WWGYDWLNTWGX', '1-C7BDSEJZJ7WGAT', '1-C2THVYDDUFUCAJ', '1-C4EGFAMTEANELN', '1-C4MZUF3ULKE1DA', '1-C6X1KF6ET6M1SE', '1-C33VMBMDV6W1J2', '1-C7DAA2U3NNBWKE', '1-C22KT26VFBACVE', '1-C2LHRBABTUUVJX', '1-CZJWLAXYCFKCJJ', '1-C662KCL1APBAGA', '1-C6T2C8AAN8KXTX', '1-C3XUVTTCFB5ZVJ', '1-C2VGAPLZMB3XGE', '1-C3LHJ2E3G662CA', '1-C4LXJ751NVMVWA', '1-C2W2PB3JUACZLX', '1-C2VZJRL3EVDXTE', '1-C3WASCJTMGADT6', '1-CY6DUA3CPEXCGT', '1-C7AHC74GL8BTME', '1-C3WKFBKGGAJKLE', '1-CYLHSE3GTCNVME', '1-C7AWHFBWNBLHNJ', '1-C35UC3JXG2XTN2', '1-C2NJVALTEPJAKE', '1-C24WGE21A23GWE', '1-C36XL3JUV4JGCA', '1-C7EZC4JTTZEATJ', '1-C32ZTX2UEKN2VJ', '1-C6WYBEW1N3LTT2', '1-C2VFGBKJGNXXRN', '1-C3KEC4M3LFCKDA', '1-C7CVETLWLF5FHA', '1-CZDEDB6FEJMHC2', '1-C3NYVYAWL63DFE', '1-C7JKCTJZFBKWEA', '1-C2WGKFKJEBXJCN', '1-C7JGRXXBLTLHWA', '1-C4EFG7DJMB4FR6', '1-C25DLAKFA6E3LE', '1-C23JCFKKA62ACJ', '1-C3BBMATBREL3HE', '1-C24AFAEVEU3KA2', '1-CZJAE32CE4KUSA', '1-C6TZDF5XNJATE6', '1-C7C3CBMWVUUYGN', '1-C3TCA2JCN6XKCT', '1-C3MKGKEHVNLCHA', '1-C6LCTFWFWA5DRX', '1-C2KEGXCHCJTJN6', '1-C4NJVZBVJUKZLE', '1-CZM1KA4TC35JE6', '1-C2EUJZA2ARA2LN', '1-C35TJ4JWRA22N6', '1-C3BURTCJAP2VNT', '1-C4DGJY5BVXT1EN', '1-C64ARY22E343C2', '1-C6KBCUJYGCKJRJ', '1-C26YLTKYJY3ZLA', '1-C4DXA3N1GJAHTN', '1-C2VFWB6JPF2DTT', '1-C62WV7ACA7ETDE', '1-C33BV3K1V32KL6', '1-C7BKNLMHCPX3TX', '1-C6AGGX5KLALTJN', '1-C4DVKFEHKABUN2', '1-C2VXPGKJLU5JEX', '1-C2WWTF2EEX5FCX', '1-C25EG3THSBEZNE', '1-C2VDGAAZKAU3AE', '1-C23YGKCUVEWECE', '1-C7BJVCKGTJDVC2', '1-C4KWUCEYVCEVJX', '1-C24BETETJGJZGX', '1-C7LWCUTKJLEGA6', '1-C23EPA5CJUCTAT', '1-C4NZBE5VDCLTVN', '1-C6WBJFEXNUWGRA', '1-C3UBTAEEVBAZRJ', '1-C3EVCTKHL4CBAN', '1-C4D1LN4AGYAUUE', '1-C25ASCKTTBEWE6', '1-CY4XJBL1CBVWLN', '1-C3NEN6W3HFWDFE', '1-C2KEV2ACJ7TWAE', '1-C3BHJKK3JAAFRX', '1-C7AVGP6WRY2ZMA', '1-C35EKE53G7WAEJ', '1-C7BYNF3HMEXVCE', '1-C3NJCF2KV7ACNN', '1-C22AG3MYKGJWHA', '1-C7ABFBTZAPEFLJ', '1-C3WBRVJTV72XTX', '1-C3LGTP2VTKUFLX', '1-C2W2V3BEGKCBN6', '1-C25TNGMZNK4CRJ', '1-C4JHT633ELECVT', '1-C6CJLY6FT6K3NJ', '1-C7JAJ7MWJYBBHA', '1-CZEJRAMDGFV3RT', '1-C7BUGJKZA2AECN', '1-C7AZTY2JSBLDEE', '1-C6BFJJXJE7VGNE', '1-C3L1TFXVTE22E6', '1-C34JABJDAYAGSE', '1-C4CDA4LFTCMTCA', '1-C2TXVCKFHFM2JJ', '1-C7LGE6ADABACC6', '1-C35KRKLFTN6TV2', '1-C6BXC4DTCKAHNJ', '1-C7CHR66CV36ZJT', '1-CY4XJBLZV7DKAN', '1-C7CAV4CXRCAETA', '1-C333JP4VKA3XAA', '1-C23YVKDXWBNAV2', '1-C6KVME5JT24TTT', '1-C2UENFKJEPAHR2', '1-C3TFNEWUBFBTFE', '1-C7DFVF3ZARA3CJ', '1-C24UNJDDT3LVTN', '1-C6XZSCLETF5WAX', '1-C7AVG7B1HA2JT2', '1-C4DWGZBGLLDYJ2')
),
monthly_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        COUNT(DISTINCT f.merchant_id) as unique_merchants,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.order_id END) as orders,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.passenger_id END) as unique_eaters,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
        AND f.merchant_id IN (SELECT merchant_id_nk FROM hon_yi_ni_merchants)
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
),
total_penang_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as total_penang_gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
)
SELECT 
    mg.month_id,
    'Hon Yi Ni' as mgs_name,
    mg.unique_merchants,
    mg.orders,
    mg.unique_eaters,
    mg.gmv,
    tp.total_penang_gmv,
    ROUND(mg.gmv * 100.0 / NULLIF(tp.total_penang_gmv, 0), 2) as gmv_pct_of_penang,
    ROUND(mg.gmv / NULLIF(mg.unique_merchants, 0), 2) as avg_gmv_per_merchant,
    ROUND(mg.gmv / NULLIF(mg.orders, 0), 2) as avg_gmv_per_order,
    ROUND(mg.gmv / NULLIF(mg.unique_eaters, 0), 2) as avg_gmv_per_eater
FROM monthly_gmv mg
INNER JOIN total_penang_gmv tp ON mg.month_id = tp.month_id
ORDER BY mg.month_id;
