name: Deploy SKU Checker
on:
  push:
    branches: [ main ]
    paths: [ "api/**" ]   # only deploy when files under api/ change
  workflow_dispatch: {}   # allow manual run from the Actions tab

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up gcloud CLI
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      # Authenticate using your service account JSON (stored as a GitHub secret)
      - name: Auth with service account key
        run: |
          echo '${{ secrets.GCP_SA_KEY_JSON }}' > /tmp/key.json
          gcloud auth activate-service-account --key-file=/tmp/key.json
          gcloud auth configure-docker -q

      # Build & push the container image using Cloud Build
      - name: Build & Push
        run: |
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT }}/sku-checker:latest api

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy sku-checker \
            --image gcr.io/${{ secrets.GCP_PROJECT }}/sku-checker:latest \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated=false \
            --set-env-vars DRIVE_FOLDER_ID=${{ secrets.DRIVE_FOLDER_ID }},GOOGLE_APPLICATION_CREDENTIALS_JSON='${{ secrets.GCP_SA_KEY_JSON }}'
