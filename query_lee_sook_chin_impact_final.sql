
WITH lee_sook_chin_merchants AS (
    SELECT merchant_id_nk
    FROM ocd_adw.d_merchant
    WHERE city_id = 13
        AND merchant_id_nk IN ('1-C2W2RZKJJTT1A6', '1-C3AWL3MDLEU2LN', '1-C2WDNA3JN73WDE', '1-C2NBV7NJNT4YTE', '1-C3EVFF3UPF4XEX', '1-C3LBJ3EWCBATLT', '1-C34XCAKTRYAUTJ', '1-C3KCJ3KWVZA3T2', '1-C3TVE63TMF2TGX', '1-C3VGTNXUA34YRX', '1-C2TDLYWDV353JE', '1-C7KJGBUAGAABNE', '1-C2EBAJA3EFLDJT', '1-C2WJL6TXWE6ERJ', '1-C3LCJJEEL2WJGX', '1-C24UGXDVNJAGNJ', '1-C65KGTMTWFKCVX', '1-C63WABU3CX5DET', '1-C3UUGLEEDAMGSA', '1-C3KBN7DAGYDVEX', '1-C22KAZL1RX6GDE', '1-C3U2GVEUAAJCV6', '1-C23HGU3KTXLTV2', '1-C3KCJ7XHGJ3XKA', '1-C3W3VTEVNU4JRN', '1-C3UFDF3WSFWKJ2', '1-C2XCJJBEFFXFHA', '1-C22GLRNGEA4ART', '1-C3U2GVETVTAYCJ', '1-C23JJ6DJLKCGJE', '1-C4BZELLKKGMCWE', '1-C23TACDEKANGNX', '1-C32KALK1NTACJA', '1-C7DZKECFJY3DEN', '1-C3DZAYCEHBWGN2', '1-C3DBEN4VGBETTX', '1-C2MAL75TKCDUMA', '1-C3UTEP5YPGK2SE', '1-C2WZJ8NHRJ6AR2', '1-C3EUKE2GJ6NBVT', '1-C33ZRVKCJTLYJJ', '1-C4EGC7UTKA6BJX', '1-C3NBETJGA2UCTA', '1-C2KWTELTJ7DHHE', '1-C22VA2UUGE2ELE', '1-C34XVBKGVENVGX', '1-C4LUEAXZCF5XUE', '1-C35GCA4FRANCNT', '1-C6WVMGC3TTCEJT', '1-C23DT36JA3KCKE', '1-C3LFPBKWLT4CTT', '1-C4CETY22VZN3LX', '1-C7K3L7V3SE6EFE', '1-C2XFRT5CCABDNE', '1-C22YEBDCFBKGGJ', '1-C4JGAY6JRNAEV6', '1-C62KNTWYAJAGEE', '1-C2XCJ33JG7VDCJ', '1-C7MEL32VLX3XUA', '1-C3EACGJHE6L2V6', '1-C3CTTXAYWEKARE', '1-C2WZE7KJJF33T2', '1-C7MXRJ3ZEJCGCJ', '1-C4CZCKJHJZNEJN', '1-C3TACT3CHGETUA', '1-C3KTG6X3NJETSE', '1-C3NHJCJXJAMEN2', '1-C3UTMF5WUALYGX', '1-C2WZERN1JANVLN', '1-C3D3FEJEGK6ZGE', '1-C3DWC2W3HEUCC2', '1-C2WGRAA1GNMJDE', '1-C2XAVT3JEZCBC2', '1-C7L1LAXYTAATT6', '1-C25AVNXDUGAHEE', '1-C32KHCDHTAAGVE', '1-C243BGBEJ4L1L2', '1-C7JKEX3HA6UVGX', '1-C3WHN3JWALJTNN', '1-C36VAN2WCUVYV2', '1-C4CKV4KEVXDTBE', '1-C4JUCPBYJVDWA2', '1-C35EE3E3R7D3WE', '1-C25TNFTXTLEZTN', '1-C7K2RKTBEFXKRJ', '1-C3M1N72XNRJ1AT', '1-C4CERVE1AP23FE', '1-C3CEMF5BTEEGR6', '1-C6NTG62HNFNHCA', '1-C2VZNT3JBFLWPE', '1-C3CCCANCECNVGN', '1-C7EDGGMXLPBUGX', '1-C3ETLZMHJTBCVX', '1-C3LAPAJJRP2HLX', '1-C25KLALHMBMTRX', '1-C3ETLJMZR7L3CN', '1-C4NBG6XCBE3KA2', '1-C3EUE3JZN2TFKA', '1-C2XUC36JLJAKGA', '1-C2WWUB3JCFE3RN', '1-C4DJCFC3CVDFCE', '1-C3VXLPW3WEJWL6', '1-C3KBTLDJGNKALX', '1-C22ZTPVXEUTEVE', '1-C3D2L64DSB6UTN', '1-C2W2V25ANJA3EN', '1-C3UGBF5HFCBJNE', '1-C36VTP3EWCKHVJ', '1-C4NCEP3WCEMZUA', '1-C3ETME4ZJENHGJ', '1-C22GNU3JAPTDVA', '1-C3LFPBKWL3EJE6', '1-C3CJC2J3TJMTME', '1-C3XTV6JWSE3KME', '1-C2XVLANYNBCGVE', '1-C3MZWAEGL8JKUE', '1-C3MEA2XCC3KGJX', '1-CZJTV33WLB2TJA', '1-C33UJUEUVTUECA', '1-C3CKTLKUT4DUSA', '1-C2WCGU3CBCJHRE', '1-C3D3GKUAL363L2', '1-C3LBLYXATADVVN', '1-C23HDCD1E2CKJE', '1-C3NZAKKBT4MCPE', '1-C2J3C3ATJ66HG2', '1-C2VKGEKJLRAZVE', '1-C3ETME4ZG6VFCJ', '1-C6XHA4LJCBAAEJ', '1-C3KDGTDZRNDVTT', '1-C3EAVEDKJX62KA', '1-C23BWGB2TUTGRJ', '1-C33GFF2FJTN2RJ', '1-C2W2RENUERBDNE', '1-C32ECJJXCPTYJJ', '1-C3M2LBEDAXBHGJ', '1-C2WWLRKJLXBCGT', '1-C3CDA2DUTNEJGN', '1-C2XGPAAXCN4XV6', '1-C3CDVE4TJY5WHA', '1-C4MFT753SBBJJE', '1-C3E1LLMZA2AAEX', '1-C7DFEUJ1ETMGSA', '1-C22YDE5TGGMKRX', '1-C3KTG6X3G7CJWA', '1-C25ATADFNXTFKE', '1-C2WWLRNGWFUDTA', '1-C2XWL8KHRAAEJ2', '1-C3CJVF4XNKA1FE', '1-C3EACGJHJGLKKA', '1-C3MKVP2VCXCXC6', '1-C3E2CX3EKB2XET', '1-C2WXTZL2JEJYJX', '1-C7L1J741VEKHSA', '1-C23ZNUDUNA61GT', '1-C35GVX3DKA2GWE', '1-C4JFT76KEKKVGA', '1-C3D2L64DT72KVJ', '1-C3D3FEJEAT4ZR2', '1-C3EBBEAHE3WGT2', '1-C222L3A1L4BJCT', '1-C4KXNYUYDBL3L2', '1-CZJ2AXW3TCCDVX', '1-C3KDJALBAYMVV6', '1-C66HEZA3L3B1AX', '1-C4NCEP3WDAETCX', '1-C36TJVKKNEVYAA', '1-C2XFRNKJDGAJV6', '1-C4NCEP3WCBUUG2', '1-C4EEJJUDNYXGFA', '1-C23YCNWYFA32C6', '1-C3DZBEBWEVMGET', '1-C2NKT3XDKA3GT2', '1-C7J2NKMALPEJAN', '1-C3KBRN6ZPFWDL2', '1-C3MVLB6FKFLYMA', '1-C4MZV76KRJBXNT', '1-C6VBJVAGBBXGJA', '1-CZJ2L8NGWGABRT', '1-C6JTCNMVNBCAPE', '1-C4L2JBEBCCEZGA', '1-C3MJWCDXCNEZAN', '1-C7EXG7MHNA3DPA', '1-C2XGR7NYAGKFHA', '1-C7KVMEC3GNKHJ2', '1-C3EWDBKGUBMCVT', '1-C65DA3NVLTEUJT', '1-C6AHE3VJSENFEX', '1-C7MVFF2BG7AACT', '1-C3MZEAEYLPNALX', '1-C3NJEE2HRCEUHE', '1-C3MZT2EKLADUA2', '1-C3D2FB2ZT74UET', '1-C4NBEGBCANDCEJ', '1-C3DXAYJHAUCXJT', '1-C3AWMCMACTTFE6', '1-C3XANP5FCXDVGA', '1-C3EBAF4UMAUYRE', '1-C2WZHBDTC2TKPE', '1-C3EBR7EDPCJYV2', '1-C4JCLTVFAP3FR6', '1-C3KHTTLGNPLCE2', '1-C3EVHAKTC7TCRJ', '1-C7KBGPMZNPCYBA', '1-C3M1UFB3J2MDTJ', '1-C341MA5FFCBDKE', '1-C3CYTLJKJU2VC6', '1-C3NCCFXUV7BKNX', '1-C3AWNK62KBT1KA', '1-C3MZTAEZGJXJLX', '1-C36GEKLBTXKACT', '1-C3JTJLEZLKKEKA', '1-C3TCBBNFNFKFGX', '1-C7LJGXNEAB4AHE', '1-C3LFT7XXT6CELX', '1-C3CDSE5JLE5WCJ', '1-C3EWA76CMENUEJ', '1-C3NXE3NBC7T3RX', '1-C3WWRE2UEZDHC6', '1-C3VGV3EVFCL2CA', '1-C4AFVTJHRENXSA', '1-C3MZUBJVLRNZAJ', '1-C26JJ63KNFJYRN', '1-C243CUJHUAWEEX', '1-C3KJNEAZG8NXEE', '1-C3DYCPDTVNCZRA', '1-C22DRCNAWA3ZRE', '1-C23BWGL1GEEDRE', '1-C6TFC2VZRRCVFE', '1-C4KXNYUZLY3ZEJ', '1-C7LDLK23EB4ZJA', '1-C4ADCUKDHBBAAJ', '1-C3LGRGJTN6WJLX', '1-C22ZTPWDRY32RX', '1-C7CVVZCCKF5WAX', '1-C3CJEJLAWBCFRA', '1-C3MKWBDHWCEKNJ', '1-C7LVN64HBEWUNX', '1-C6TVTRCEAF2KGJ', '1-C3KTAE5GG2XJMA', '1-C7CVVZCDLFTCA2', '1-C2UATELYR26HGX', '1-C7M3E6WWECBXJT', '1-C2X2VT3JLY5TVX', '1-C4NXCTTVA4NYV6', '1-C6TEC2LUET5KGX', '1-C22AGU6WAUA1LA', '1-C2XBKA3VLN33LA', '1-C4LZWF4XKA2KN6', '1-CZKUPFKBJJ41V6', '1-C3UEGNXELEXTWE', '1-C3NBCPAEGCAYV2', '1-C3KHR4KAVF4HEA', '1-C3N3FCEKC2MHT6', '1-C4AARUUZGRLFEE', '1-C7NAEB3VRELKG6', '1-C3DZAYCELVBGAA', '1-C25KLVEWSBJYN6', '1-C7ACBCMTPB2GVE', '1-C4JTGNAYE2LDJ6', '1-C3UVWFWVJAMKGT', '1-C3DZC2JKJ3JYJX', '1-C3D2RF2HE3BAT6', '1-C3DBVFLTGCE1EJ', '1-C35VVTEXGVETAE', '1-C3EWECJEJKKVRJ', '1-C2XUC33JLTLGUE', '1-C3L1C4JJE73GN6', '1-C2WYLEDFCB52L6', '1-C3NBDE2KGBM3LA', '1-C3W2WE3DEVLJVE', '1-C3BHKBL2JGM3JN', '1-C3EACYCGNJ5KCJ', '1-C3KCJ3KWVZBAVA', '1-C3UUJKJJEUUET2', '1-C7KKRF22NKECCN', '1-C2WZJB3JAZCJPA', '1-C4LFVKNXGYTKEN', '1-C2XWN6NACEEBLX', '1-C6XJV75KLRL3JJ', '1-C25VEXBGEXNVEX', '1-C7MBG2EXVAJJUE', '1-C3UZJTEUFFC2VE', '1-C66WGTXBN8LHEE', '1-C3M1V7W3A8C2AN', '1-C3CTTAEVE2J2LJ', '1-C7LDC6NYJKKZA2', '1-C3DKPANATT3EAN', '1-C221SA42LXA1RN', '1-C7M2GALARYEVR6', '1-C3KEHF3XUGJ3RA', '1-C7DHTXVZEJT3JN', '1-C3EVCF4FSADVT2', '1-C34FHCJCJUXGEA', '1-C3CJVF4XLT5HRX', '1-C3XEAUJCC4LCPE', '1-C2XUC33JJJNUL2', '1-C3X3RTKDV7NFSA', '1-C2NKVRC1AB6HRX', '1-C3DKNY2HNXLWCA', '1-C4A1UAMKNFEDLJ', '1-C2WJL6MCLU22GT', '1-C6T2DEJUL7NBE6', '1-C3CCAF5BTFKFTT', '1-C3UFGBETA3UHNJ', '1-C3KTE3EEJB5KMA', '1-C3MZWFBVLNCCLA', '1-C2UBJ6KHEYCWE6', '1-C3BURY3UNU52L2', '1-C6MFEY3ABCLTGX', '1-C633RRDXGJJZAJ', '1-C3CJCXTWJ6AVV2', '1-C3ETJ2EYPEKYDA', '1-C3WEC2EUE732VA', '1-C2W2REKJACKDCE', '1-C2VJSGLVPE4FEJ', '1-C65YJA5AV64TCJ', '1-C3TFL7XANX53JA', '1-C6WALK5VJYBASA', '1-C26KLTVTPEEDVX', '1-C2DCV7UDLXMYVE', '1-C3DZAYCEJKMECT', '1-C3DHCKMJG7VHPE', '1-C3VKG72UBBXCLN', '1-CZJ3L7BHKFEEA2', '1-C3EBBEAHHCKGFE', '1-C3VKNF3GCCEHLA', '1-C4MKWE61R3BJCN', '1-C26UEN2JEETBSA')
),
monthly_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        COUNT(DISTINCT f.merchant_id) as unique_merchants,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.order_id END) as orders,
        COUNT(DISTINCT CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.passenger_id END) as unique_eaters,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
        AND f.merchant_id IN (SELECT merchant_id_nk FROM lee_sook_chin_merchants)
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
),
total_penang_gmv AS (
    SELECT 
        CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER) as month_id,
        SUM(CASE WHEN f.booking_state_simple = 'COMPLETED' THEN f.gross_merchandise_value ELSE 0 END) as total_penang_gmv
    FROM ocd_adw.f_food_metrics f
    WHERE f.city_id = 13
        AND f.country_id = 1
        AND f.date_id >= 20250501
        AND f.date_id < 20251101
        AND f.business_type = 0
    GROUP BY CAST(SUBSTRING(CAST(f.date_id AS VARCHAR), 1, 6) AS INTEGER)
)
SELECT 
    mg.month_id,
    'Lee Sook Chin' as mgs_name,
    mg.unique_merchants,
    mg.orders,
    mg.unique_eaters,
    mg.gmv,
    tp.total_penang_gmv,
    ROUND(mg.gmv * 100.0 / NULLIF(tp.total_penang_gmv, 0), 2) as gmv_pct_of_penang,
    ROUND(mg.gmv / NULLIF(mg.unique_merchants, 0), 2) as avg_gmv_per_merchant,
    ROUND(mg.gmv / NULLIF(mg.orders, 0), 2) as avg_gmv_per_order,
    ROUND(mg.gmv / NULLIF(mg.unique_eaters, 0), 2) as avg_gmv_per_eater
FROM monthly_gmv mg
INNER JOIN total_penang_gmv tp ON mg.month_id = tp.month_id
ORDER BY mg.month_id;
